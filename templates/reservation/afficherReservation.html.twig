{% extends 'base.html.twig' %}

{% block title %}Liste des Réservations{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Override any inherited blue background with white */
        body, .main, .section {
            background-color: #fff !important; /* Ensure full page is white */
            min-height: 70vh; /* Ensure the page takes full height */
            display: flex;
            flex-direction: column;
        }
        .page-header {
            margin-bottom: 20px;
        }
        .page-header h1 {
            font-size: 2rem;
            color: #2c3e50;
            margin: 0;
        }
        .filter-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .filter-container input {
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 8px 12px;
            width: 200px;
        }
        .filter-container input:focus {
            border-color: #3498db;
            outline: none;
        }
        .new-reservation-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }
        .new-reservation-btn:hover {
            background-color: #2c80b9;
        }
        .reservation-table {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            flex: 1 0 auto; /* Allow the table to grow but not shrink */
        }
        .reservation-table .table {
            margin-bottom: 0;
            background: #fff;
        }
        .reservation-table th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            padding: 12px;
            border-bottom: 2px solid #e9ecef;
            text-align: left;
            cursor: pointer;
        }
        .reservation-table th:hover {
            background-color: #e9ecef;
        }
        .reservation-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
            vertical-align: middle;
        }
        .reservation-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .reservation-table tr:hover {
            background-color: #e9ecef;
        }
        .reservation-table tr:last-child td {
            border-bottom: none;
        }
        .reservation-event {
            color: #2c3e50;
            text-decoration: none;
        }
        .reservation-event:hover {
            color: #3498db;
        }
        .btn-action {
            border: 1px solid #ced4da;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            background-color: #fff;
            color: #495057;
            margin: 0 2px;
            transition: all 0.2s ease;
        }
        .btn-action:hover {
            background-color: #f1f1f1;
            color: #2c3e50;
            transform: scale(1.1);
        }
        .empty-message {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            color: #6c757d;
        }
        .reservation-table .table-responsive {
            max-height: 60vh;
            overflow-y: auto;
            display: block;
        }
        .reservation-table thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: #f8f9fa;
        }
       
        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-container input {
                width: 100%;
            }
            .new-reservation-btn {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            .reservation-table {
                display: block;
                overflow-x: auto;
            }
            .reservation-table table {
                width: 100%;
                min-width: 600px;
            }
            .reservation-table td,
            .reservation-table th {
                padding: 8px;
                font-size: 0.9em;
            }
            .btn-action {
                width: 25px;
                height: 25px;
                font-size: 0.8em;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <main id="main" class="main">
        <div class="pagetitle">
            <h1><i class="bi bi-ticket-perforated me-2"></i> Liste des Réservations</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active">Réservations</li>
                </ol>
            </nav>
        </div>

        <section class="section">
            <div class="container">
                <!-- Flash Messages Container -->
                <div id="flash-messages">
                    {% for message in app.flashes('success') %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i> {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                    {% for message in app.flashes('error') %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                    {% for message in app.flashes('info') %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <i class="bi bi-info-circle-fill me-2"></i> {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>

                <!-- Filter and Action Container -->
                <div class="filter-container">
                    <div>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Rechercher par événement..." aria-label="Rechercher des réservations">
                    </div>
                    <div>
                        <a href="{{ path('app_reservation_new') }}" class="new-reservation-btn">
                            <i class="bi bi-plus-circle me-2"></i> Créer une nouvelle réservation
                        </a>
                    </div>
                </div>

                <!-- Table View -->
                {% if reservations is not empty %}
                    <div class="reservation-table">
                        <div class="table-responsive">
                            <table class="table mb-0" id="reservationTable">
                                <thead>
                                    <tr>
                                        <th data-sort="id">ID</th>
                                        <th data-sort="event">Événement</th>
                                        <th data-sort="date">Date de Réservation</th>
                                        <th data-sort="comment">Commentaire</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reservation in reservations %}
                                        <tr class="reservation-row" 
                                            id="reservation_{{ reservation.id }}"
                                            data-event="{{ reservation.evenement.titre | lower }}">
                                            <td>{{ reservation.id }}</td>
                                            <td class="reservation-event">{{ reservation.evenement.titre }}</td>
                                            <td>
                                                {% if reservation.dateRev %}
                                                    <i class="bi bi-calendar-event me-1"></i>
                                                    {{ reservation.dateRev|date('d/m/Y H:i') }}
                                                {% else %}
                                                    <span class="text-muted">Non défini</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if reservation.commentaire %}
                                                    {{ reservation.commentaire|length > 50 ? reservation.commentaire|slice(0, 50) ~ '...' : reservation.commentaire }}
                                                {% else %}
                                                    <span class="text-muted">Aucun commentaire</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <a href="{{ path('app_reservation_edit', {'id': reservation.id}) }}" 
                                                   class="btn btn-warning btn-action" 
                                                   title="Modifier">
                                                    <i class="bi bi-pencil-fill"></i>
                                                </a>
                                                <form method="POST" 
                                                      action="{{ path('app_reservation_delete', {'id': reservation.id}) }}" 
                                                      style="display:inline;"
                                                      data-turbo="true"
                                                      data-turbo-stream="true"
                                                      onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette réservation ?');">
                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reservation.id) }}">
                                                    <button type="submit" 
                                                            class="btn btn-danger btn-action" 
                                                            title="Supprimer">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                    <div class="empty-message">
                        <h4>Aucune réservation trouvée</h4>
                    </div>
                {% endif %}
            </div>
        </section>


    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Filter and Search Reservations
            const searchFilter = document.getElementById('searchFilter');
            const reservationTable = document.getElementById('reservationTable');
            const rows = reservationTable ? reservationTable.querySelectorAll('.reservation-row') : [];

            function filterReservations() {
                const searchText = searchFilter.value.toLowerCase().trim();
                rows.forEach(row => {
                    const rowEvent = row.getAttribute('data-event').toLowerCase();
                    const searchMatch = !searchText || rowEvent.includes(searchText);
                    row.style.display = searchMatch ? '' : 'none';
                });
            }

            searchFilter.addEventListener('input', filterReservations);

            // Basic Sorting
            const ths = reservationTable ? reservationTable.querySelectorAll('th[data-sort]') : [];
            let sortDirection = 1;
            let lastSortedColumn = null;

            ths.forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    if (lastSortedColumn !== column) {
                        sortDirection = 1;
                        lastSortedColumn = column;
                    } else {
                        sortDirection *= -1;
                    }

                    const tbody = reservationTable.querySelector('tbody');
                    const rowsArray = Array.from(tbody.querySelectorAll('tr'));

                    rowsArray.sort((a, b) => {
                        let aValue = a.cells[Array.from(ths).indexOf(th)].textContent.trim();
                        let bValue = b.cells[Array.from(ths).indexOf(th)].textContent.trim();

                        if (column === 'date' && aValue !== 'Non défini') {
                            aValue = new Date(aValue.split(' ')[0].split('/').reverse().join('-') + ' ' + aValue.split(' ')[1]);
                            bValue = new Date(bValue.split(' ')[0].split('/').reverse().join('-') + ' ' + bValue.split(' ')[1]);
                        }

                        if (aValue < bValue) return -1 * sortDirection;
                        if (aValue > bValue) return 1 * sortDirection;
                        return 0;
                    });

                    rowsArray.forEach(row => tbody.appendChild(row));
                });
            });
        });
    </script>
{% endblock %}